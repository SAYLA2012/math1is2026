<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MATEMATIK 1 IBNU SIRIN - Senarai Semakan</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @media print {
      .no-print { display: none !important; }
      .print-table { font-size: 10px !important; width: 100% !important; }
      .print-table th, .print-table td { padding: 4px 6px !important; border: 1px solid #cbd5e1 !important; }
      body { background-color: white !important; padding: 0 !important; }
      .dynamic-col-hidden { display: none !important; }
    }
    .status-submitted { background-color: #dcfce7 !important; color: #166534 !important; }
    .status-missing { background-color: #fee2e2 !important; color: #991b1b !important; }
    body { box-sizing: border-box; }
    #autosave-status { transition: opacity 0.3s; }
  </style>
</head>
<body class="h-full bg-slate-100 font-['Plus_Jakarta_Sans']">
  <div id="app" class="h-full overflow-auto">
    <div class="max-w-full mx-auto p-4 md:p-6">
      
      <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl shadow-lg p-6 mb-6 text-white relative">
        <div id="autosave-status" class="absolute top-2 right-4 text-[10px] opacity-0 bg-white/20 px-2 py-1 rounded">âœ“ Auto-saved</div>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold mb-1">MATEMATIK 1 IBNU SIRIN</h1>
            <p class="text-emerald-100 text-lg">Senarai Semakan Hasil Kerja Murid 2026</p>
          </div>
          <div class="flex flex-wrap gap-2 no-print">
            <button onclick="saveAndRefresh(true)" class="bg-white text-emerald-700 hover:bg-emerald-50 px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-sm"> ğŸ’¾ Simpan </button>
            <button onclick="window.print()" class="bg-emerald-800/40 hover:bg-emerald-800/60 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 border border-white/20"> ğŸ–¨ï¸ Cetak Semua </button>
          </div>
        </div>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 no-print shadow-sm">
        <h2 class="font-bold text-blue-800 mb-3 flex items-center gap-2 text-sm">ğŸ“… Cetak Mengikut Tarikh/Latihan</h2>
        <div class="flex flex-wrap gap-3 items-end">
          <div class="flex-1 min-w-[200px]">
            <select id="print-date-selector" class="w-full px-3 py-2 border border-blue-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm">
              <option value="all">-- Semua Tarikh --</option>
            </select>
          </div>
          <button onclick="printByDate()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition shadow-md text-sm"> Tapis & Cetak </button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-4 mb-6 no-print">
        <form id="add-student-form" class="flex flex-col sm:flex-row gap-3">
          <input type="text" id="new-student-name" placeholder="Masukkan nama murid baru..." class="flex-1 px-4 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" required> 
          <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition"> + Tambah Murid </button>
        </form>
      </div>

      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table id="checklist-table" class="w-full print-table">
            <thead class="bg-slate-50">
              <tr id="date-row">
                <th class="sticky left-0 bg-slate-50 px-3 py-3 text-left border-b border-r border-slate-200 w-12 no-print">#</th>
                <th class="sticky left-12 bg-slate-50 px-3 py-3 text-left text-xs font-bold text-slate-600 uppercase border-b border-r border-slate-200 min-w-[150px]">Nama Murid</th>
                <th id="notes-header" class="px-3 py-3 text-left text-xs font-bold text-slate-600 uppercase border-b border-slate-200 min-w-[150px]">Catatan</th>
              </tr>
            </thead>
            <tbody id="student-list" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    let config = {
      dates: JSON.parse(localStorage.getItem('checklist_dates')) || Array(10).fill(''),
      exercises: JSON.parse(localStorage.getItem('checklist_exercises')) || Array(10).fill('').map((_,i) => `Latihan ${i+1}`)
    };

    let students = JSON.parse(localStorage.getItem('checklist_students')) || [];

    function init() {
      renderTableHeaders();
      renderStudents();
      updateDateSelector();
    }

    function showAutoSaveStatus() {
      const status = document.getElementById('autosave-status');
      status.style.opacity = '1';
      setTimeout(() => status.style.opacity = '0', 2000);
    }

    function renderTableHeaders() {
      const dateRow = document.getElementById('date-row');
      const notesHeader = document.getElementById('notes-header');
      dateRow.querySelectorAll('.dynamic-col').forEach(el => el.remove());

      config.dates.forEach((dateVal, i) => {
        const th = document.createElement('th');
        th.className = `dynamic-col col-index-${i} px-2 py-2 text-center border-b border-r border-slate-200 min-w-[100px]`;
        th.innerHTML = `
          <div class="no-print">
            <input type="text" value="${config.exercises[i]}" onchange="updateEx(${i}, this.value)" class="w-full text-[10px] font-bold border-none text-center focus:ring-0 bg-transparent" placeholder="Tajuk">
            <input type="date" value="${dateVal}" onchange="updateDate(${i}, this.value)" class="w-full text-[10px] border rounded p-1">
          </div>
          <div class="hidden print:block text-center">
            <div class="font-bold text-[10px] uppercase">${config.exercises[i]}</div>
            <div class="text-[9px]">${dateVal || ''}</div>
          </div>
        `;
        dateRow.insertBefore(th, notesHeader);
      });
    }

    function renderStudents() {
      const tbody = document.getElementById('student-list');
      let sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name));

      tbody.innerHTML = sortedStudents.map((student) => `
        <tr class="hover:bg-slate-50 transition">
          <td class="sticky left-0 bg-white px-3 py-2 text-center border-r border-slate-200 no-print text-xs text-slate-400">
             <button onclick="deleteStudent('${student.id}')" class="hover:text-red-600">ğŸ—‘ï¸</button>
          </td>
          <td class="sticky left-12 bg-white px-3 py-2 border-r border-slate-200 font-medium text-sm">
            ${student.name}
          </td>
          ${config.dates.map((_, i) => {
            const status = student.status[i] || '';
            const btnClass = status === 'âœ“' ? 'status-submitted font-bold' : (status === 'âœ—' ? 'status-missing font-bold' : 'bg-slate-50 text-slate-300');
            return `
              <td class="dynamic-col col-index-${i} px-2 py-2 text-center border-r border-slate-200">
                <button onclick="toggleStatus('${student.id}', ${i})" class="w-8 h-8 rounded border transition-all no-print ${btnClass}">
                  ${status || 'â€”'}
                </button>
                <div class="hidden print:block">${status || ''}</div>
              </td>
            `;
          }).join('')}
          <td class="px-2 py-2">
            <textarea oninput="autoSaveNote('${student.id}', this.value)" class="w-full text-xs p-1 border rounded h-8 no-print resize-none">${student.note || ''}</textarea>
            <div class="hidden print:block text-[9px]">${student.note || ''}</div>
          </td>
        </tr>
      `).join('');
    }

    function printByDate() {
      const selectedIndex = document.getElementById('print-date-selector').value;
      document.querySelectorAll('.dynamic-col').forEach(el => el.classList.remove('dynamic-col-hidden'));

      if (selectedIndex !== 'all') {
        config.dates.forEach((_, i) => {
          if (i != selectedIndex) {
            document.querySelectorAll(`.col-index-${i}`).forEach(el => el.classList.add('dynamic-col-hidden'));
          }
        });
      }
      window.print();
    }

    function updateDateSelector() {
      const selector = document.getElementById('print-date-selector');
      selector.innerHTML = '<option value="all">-- Semua Tarikh & Latihan --</option>';
      config.dates.forEach((d, i) => {
        if(d || config.exercises[i]) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `${config.exercises[i]} (${d || 'Tiada Tarikh'})`;
          selector.appendChild(opt);
        }
      });
    }

    function saveAndRefresh(manual = false) {
      localStorage.setItem('checklist_students', JSON.stringify(students));
      localStorage.setItem('checklist_dates', JSON.stringify(config.dates));
      localStorage.setItem('checklist_exercises', JSON.stringify(config.exercises));
      
      showAutoSaveStatus();
      if(manual) alert('Rekod disimpan!');
      
      updateDateSelector();
      renderTableHeaders();
      renderStudents();
    }

    let noteTimer;
    window.autoSaveNote = (id, val) => {
        clearTimeout(noteTimer);
        noteTimer = setTimeout(() => {
            students.find(s => s.id === id).note = val;
            localStorage.setItem('checklist_students', JSON.stringify(students));
            showAutoSaveStatus();
        }, 500);
    };

    window.updateDate = (i, val) => { config.dates[i] = val; saveAndRefresh(); };
    window.updateEx = (i, val) => { config.exercises[i] = val; saveAndRefresh(); };
    window.toggleStatus = (id, index) => {
      const s = students.find(s => s.id === id);
      const cur = s.status[index];
      s.status[index] = cur === '' ? 'âœ“' : (cur === 'âœ“' ? 'âœ—' : '');
      saveAndRefresh();
    };

    window.deleteStudent = (id) => {
        if(confirm('Padam murid ini?')) {
            students = students.filter(s => s.id !== id);
            saveAndRefresh();
        }
    };

    document.getElementById('add-student-form').onsubmit = (e) => {
      e.preventDefault();
      const input = document.getElementById('new-student-name');
      students.push({ id: Date.now().toString(), name: input.value.toUpperCase(), status: Array(10).fill(''), note: '' });
      input.value = '';
      saveAndRefresh();
    };

    init();
  </script>
</body>
</html>
